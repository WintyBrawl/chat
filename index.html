<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Личный Мессенджер</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #2E7D32;
            background-image: linear-gradient(to bottom, #1B5E20 0%, #4CAF50 100%);
            min-height: 100vh;
            padding: 10px;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #E8F5E9;
            border: 2px solid #1B5E20;
            border-radius: 10px;
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
            max-height: none;
        }

        .header {
            background: linear-gradient(to right, #1B5E20, #2E7D32);
            color: white;
            padding: 12px 10px;
            text-align: center;
            border-bottom: 2px solid #FF9800;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            font-size: 20px;
            text-shadow: 1px 1px 0 #000;
            font-weight: 700;
        }

        .header p {
            font-size: 11px;
            margin-top: 3px;
            color: #C8E6C9;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        /* Мобильная версия: боковая панель превращается в верхнюю панель */
        .sidebar {
            width: 100%;
            background-color: #F1F8E9;
            border-bottom: 2px solid #A5D6A7;
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
            max-height: 40vh;
        }

        .chat-area {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .login-panel, .user-panel {
            background-color: #F1F8E9;
            border: 2px solid #66BB6A;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .contacts-panel {
            background-color: #F1F8E9;
            border: 2px solid #66BB6A;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            background-color: #FFFFFF;
            border: 2px solid #66BB6A;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 10px;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            max-width: 90%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 14px;
        }

        .message-sent {
            background-color: #C8E6C9;
            margin-left: auto;
            border: 1px solid #4CAF50;
            margin-right: 5px;
        }

        .message-received {
            background-color: #E8F5E9;
            border: 1px solid #81C784;
            margin-left: 5px;
        }

        .message-sender {
            font-weight: bold;
            color: #1B5E20;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 10px;
            color: #666666;
            text-align: right;
            margin-top: 4px;
        }

        .message-input {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            align-items: flex-end;
        }

        input, button, textarea {
            padding: 12px 10px;
            border: 2px solid #81C784;
            border-radius: 8px;
            font-size: 15px;
            -webkit-appearance: none;
        }

        input, textarea {
            flex: 1;
            background-color: #FFFFFF;
            min-width: 0;
            font-size: 15px;
        }

        textarea {
            resize: none;
            height: 55px;
            font-family: 'Roboto', sans-serif;
            line-height: 1.4;
        }

        button {
            background: linear-gradient(to bottom, #F1F8E9, #C8E6C9);
            color: #1B5E20;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            min-height: 50px;
            padding: 12px 15px;
            font-size: 15px;
            border: 2px solid #81C784;
        }

        button:hover {
            background: linear-gradient(to bottom, #E8F5E9, #A5D6A7);
        }

        button:active {
            background: linear-gradient(to bottom, #C8E6C9, #81C784);
        }

        .login-input {
            width: 100%;
            margin-bottom: 10px;
            padding: 12px;
            font-size: 16px;
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(to bottom, #4CAF50, #388E3C);
            color: white;
            font-weight: bold;
            border: 1px solid #2E7D32;
            padding: 14px;
            font-size: 16px;
        }

        .delete-account-btn {
            background: linear-gradient(to bottom, #D32F2F, #B71C1C);
            color: white;
            font-weight: bold;
            border: 1px solid #C62828;
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            font-size: 15px;
        }

        .current-user {
            font-weight: bold;
            color: #1B5E20;
            margin-bottom: 12px;
            padding: 10px;
            background-color: #C8E6C9;
            border-radius: 8px;
            font-size: 14px;
        }

        .user-id {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            word-break: break-all;
            background-color: #FFF;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #A5D6A7;
        }

        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            left: 15px;
            background-color: #FFF9C4;
            border: 2px solid #FFB300;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            max-width: none;
            text-align: center;
            font-size: 14px;
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .footer {
            background-color: #1B5E20;
            color: #C8E6C9;
            text-align: center;
            padding: 8px;
            font-size: 10px;
            border-top: 2px solid #FF9800;
            flex-shrink: 0;
        }

        .window-title {
            background: linear-gradient(to right, #1B5E20, #2E7D32);
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            border-bottom: 1px solid #1B5E20;
            margin: -12px -12px 12px -12px;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
        }

        .contact-item {
            padding: 12px 10px;
            border-bottom: 1px solid #C8E6C9;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .contact-item:hover {
            background-color: #E8F5E9;
        }

        .contact-item.active {
            background-color: #C8E6C9;
            border-left: 4px solid #1B5E20;
        }

        .contact-name {
            font-weight: bold;
            color: #1B5E20;
            font-size: 14px;
        }

        .contact-id {
            font-size: 11px;
            color: #666;
        }

        .add-contact-panel {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #A5D6A7;
        }

        .add-contact-input {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* Улучшения для скроллбаров на мобильных */
        .chat-messages::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar,
        .contacts-list::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track,
        .contacts-list::-webkit-scrollbar-track {
            background: #F1F8E9;
            border-left: 1px solid #A5D6A7;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb,
        .contacts-list::-webkit-scrollbar-thumb {
            background: #81C784;
            border: 2px solid #F1F8E9;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover,
        .contacts-list::-webkit-scrollbar-thumb:hover {
            background: #66BB6A;
        }

        .empty-chat {
            text-align: center;
            color: #666;
            padding: 30px 15px;
            font-style: italic;
            font-size: 14px;
        }
        
        .copy-id-btn {
            background: linear-gradient(to bottom, #2196F3, #1976D2);
            color: white;
            font-size: 12px;
            padding: 8px;
            margin-top: 8px;
            width: 100%;
            border-radius: 5px;
            border: none;
        }
        
        .new-message-indicator {
            background-color: #FF5722;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            flex-shrink: 0;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 16px;
            padding: 20px;
            text-align: center;
        }
        
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 15px;
        }
        
        .confirmation-box {
            background-color: #FFF;
            border: 2px solid #D32F2F;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .confirmation-title {
            color: #D32F2F;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .confirmation-text {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
            font-size: 14px;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 10px;
        }
        
        .confirm-btn {
            flex: 1;
            background: linear-gradient(to bottom, #D32F2F, #B71C1C);
            color: white;
            font-weight: bold;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
        }
        
        .cancel-btn {
            flex: 1;
            background: linear-gradient(to bottom, #757575, #616161);
            color: white;
            font-weight: bold;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
        }

        /* СТИЛИ ДЛЯ ПРОФИЛЯ */
        .profile-btn {
            background: linear-gradient(to bottom, #FF9800, #F57C00);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            border: 2px solid #FFB74D;
            cursor: pointer;
            white-space: nowrap;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }

        .profile-btn:hover {
            background: linear-gradient(to bottom, #F57C00, #E65100);
        }

        .profile-btn:active {
            background: linear-gradient(to bottom, #FFB74D, #FF9800);
        }

        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 15px;
        }

        .profile-box {
            background-color: #FFF;
            border: 3px solid #FF9800;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
            max-height: 85vh;
            overflow-y: auto;
        }

        .profile-title {
            color: #1B5E20;
            font-size: 22px;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #FF9800;
            padding-bottom: 10px;
        }

        .profile-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #F9FDF9;
            border-radius: 10px;
            border: 2px solid #C8E6C9;
        }

        .profile-section-title {
            color: #1B5E20;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-input-group {
            margin-bottom: 15px;
        }

        .profile-input-group label {
            display: block;
            color: #555;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .profile-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #81C784;
            border-radius: 8px;
            font-size: 15px;
            background-color: white;
        }

        .profile-input:focus {
            border-color: #FF9800;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
        }

        .profile-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #C8E6C9;
        }

        .profile-info-label {
            color: #666;
            font-size: 14px;
            font-weight: bold;
        }

        .profile-info-value {
            color: #1B5E20;
            font-size: 14px;
            font-weight: bold;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        .profile-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .profile-save-btn {
            flex: 1;
            background: linear-gradient(to bottom, #4CAF50, #388E3C);
            color: white;
            font-weight: bold;
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .profile-cancel-btn {
            flex: 1;
            background: linear-gradient(to bottom, #757575, #616161);
            color: white;
            font-weight: bold;
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .profile-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .profile-close-btn:hover {
            background-color: #f0f0f0;
        }

        .profile-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 13px;
            display: none;
        }

        .profile-status.success {
            background-color: #C8E6C9;
            color: #1B5E20;
            border: 1px solid #4CAF50;
            display: block;
        }

        .profile-status.error {
            background-color: #FFCDD2;
            color: #C62828;
            border: 1px solid #F44336;
            display: block;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
            border: 4px solid #FF9800;
        }

        .profile-avatar-text {
            font-size: 36px;
        }

        .last-seen-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .last-seen-online {
            background-color: #4CAF50;
            color: white;
        }

        .last-seen-offline {
            background-color: #757575;
            color: white;
        }

        /* Медиа-запросы для адаптивности */
        @media (min-width: 768px) {
            .container {
                height: 90vh;
                max-height: 800px;
            }
            
            .main-content {
                flex-direction: row;
            }
            
            .sidebar {
                width: 250px;
                max-height: none;
                border-right: 2px solid #A5D6A7;
                border-bottom: none;
            }
            
            .notification {
                left: auto;
                right: 20px;
                max-width: 300px;
            }
            
            .message {
                max-width: 85%;
            }

            .profile-btn {
                font-size: 14px;
                padding: 10px 20px;
            }
        }

        @media (max-width: 767px) {
            body {
                padding: 5px;
            }
            
            .container {
                height: 98vh;
                border-radius: 8px;
            }
            
            .header {
                padding: 10px 8px;
                flex-direction: column;
                gap: 10px;
            }
            
            .header-content {
                width: 100%;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .sidebar {
                max-height: 35vh;
            }
            
            .chat-area {
                padding: 8px;
            }
            
            .message-input {
                flex-direction: column;
                gap: 8px;
            }
            
            textarea {
                width: 100%;
                height: 60px;
            }
            
            #sendBtn {
                width: 100%;
                min-height: 45px;
            }
            
            .add-contact-input {
                flex-direction: column;
            }
            
            #friendIdInput, #addFriendBtn {
                width: 100%;
            }
            
            #addFriendBtn {
                min-height: 45px;
            }
            
            .confirmation-buttons {
                flex-direction: column;
            }

            .profile-btn {
                width: 100%;
                margin-left: 0;
                margin-top: 5px;
            }

            .profile-box {
                padding: 15px;
            }

            .profile-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 16px;
            }
            
            .header p {
                font-size: 10px;
            }
            
            .message {
                max-width: 95%;
                font-size: 13px;
                padding: 7px 9px;
            }
            
            .message-text {
                font-size: 13px;
            }
            
            input, button, textarea {
                padding: 10px;
                font-size: 14px;
            }
            
            .footer {
                font-size: 9px;
                padding: 6px;
            }
            
            .sidebar {
                max-height: 30vh;
                padding: 8px;
            }
            
            .window-title {
                padding: 6px 10px;
                font-size: 13px;
                margin: -8px -8px 8px -8px;
            }

            .profile-title {
                font-size: 18px;
            }

            .profile-section-title {
                font-size: 14px;
            }
        }

        /* Улучшения для очень маленьких экранов */
        @media (max-height: 600px) {
            .sidebar {
                max-height: 25vh;
            }
            
            .chat-messages {
                padding: 8px;
            }
            
            .message {
                margin-bottom: 6px;
                padding: 6px 8px;
            }

            .profile-box {
                max-height: 90vh;
            }
        }

        /* Стили для клавиатуры на iOS */
        @supports (-webkit-overflow-scrolling: touch) {
            input, textarea {
                font-size: 16px; /* Предотвращает увеличение в iOS */
            }
        }

        /* Улучшенные стили для активных элементов */
        button:active, .contact-item:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* Убираем выделение при тапе на мобильных */
        button, .contact-item, input, textarea {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div>Загрузка мессенджера...</div>
    </div>
    
    <div id="confirmationModal" class="confirmation-modal" style="display: none;">
        <div class="confirmation-box">
            <div class="confirmation-title">Удаление аккаунта</div>
            <div class="confirmation-text">
                Вы точно хотите удалить аккаунт?<br>
                <span style="color: #D32F2F; font-weight: bold;">Это действие нельзя отменить!</span><br><br>
                Будут удалены:
                <ul style="text-align: left; margin: 10px 0 10px 20px; font-size: 13px;">
                    <li>Ваш профиль</li>
                    <li>Все ваши контакты</li>
                    <li>Вся история сообщений</li>
                </ul>
            </div>
            <div class="confirmation-buttons">
                <button id="confirmDeleteBtn" class="confirm-btn">Да, удалить аккаунт</button>
                <button id="cancelDeleteBtn" class="cancel-btn">Отмена</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно профиля -->
    <div id="profileModal" class="profile-modal" style="display: none;">
        <div class="profile-box">
            <button id="profileCloseBtn" class="profile-close-btn">×</button>
            
            <div class="profile-title">Мой профиль</div>
            
            <div id="profileStatus" class="profile-status"></div>
            
            <div class="profile-avatar">
                <div id="profileAvatarText" class="profile-avatar-text"></div>
            </div>
            
            <div class="profile-section">
                <div class="profile-section-title">
                    <span>Основная информация</span>
                </div>
                
                <div class="profile-input-group">
                    <label for="profileNameInput">Имя пользователя:</label>
                    <input type="text" id="profileNameInput" class="profile-input" maxlength="20" placeholder="Введите новое имя">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Максимум 20 символов. Имя будет обновлено у всех ваших контактов.
                    </div>
                </div>
                
                <div class="profile-info-item">
                    <div class="profile-info-label">Ваш ID:</div>
                    <div class="profile-info-value" id="profileUserId"></div>
                </div>
                
                <div class="profile-info-item">
                    <div class="profile-info-label">Статус:</div>
                    <div class="profile-info-value">
                        <span id="profileStatusText">В сети</span>
                        <span id="lastSeenBadge" class="last-seen-status last-seen-online">онлайн</span>
                    </div>
                </div>
                
                <div class="profile-info-item">
                    <div class="profile-info-label">Аккаунт создан:</div>
                    <div class="profile-info-value" id="profileCreatedAt"></div>
                </div>
            </div>
            
            <div class="profile-buttons">
                <button id="profileSaveBtn" class="profile-save-btn">Сохранить изменения</button>
                <button id="profileCancelBtn" class="profile-cancel-btn">Закрыть</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Личный Мессенджер</h1>
                <p>Общайтесь приватно с друзьями</p>
            </div>
            <button id="profileBtn" class="profile-btn" style="display: none;">Мой профиль</button>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="login-panel" id="loginPanel">
                    <div class="window-title">Вход в мессенджер</div>
                    <input type="text" id="usernameInput" class="login-input" placeholder="Введите ваше имя" maxlength="20">
                    <button id="loginBtn" class="login-btn">Войти</button>
                </div>
                
                <div class="user-panel" id="userPanel" style="display: none;">
                    <div class="current-user">
                        <div>Вы: <span id="currentUserName"></span></div>
                        <div class="user-id">Ваш ID: <span id="currentUserId"></span></div>
                        <button id="copyIdBtn" class="copy-id-btn">Скопировать ID</button>
                    </div>
                    
                    <div class="contacts-panel">
                        <div class="window-title">Контакты</div>
                        <div class="add-contact-panel">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Добавить друга по ID:</div>
                            <div class="add-contact-input">
                                <input type="text" id="friendIdInput" placeholder="ID друга (до 8 символов)" maxlength="8">
                                <button id="addFriendBtn">Добавить</button>
                            </div>
                        </div>
                        <div class="contacts-list" id="contactsList">
                            <div class="empty-chat">Добавьте друга по ID</div>
                        </div>
                    </div>
                    
                    <button id="deleteAccountBtn" class="delete-account-btn">Удалить аккаунт</button>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-chat">Выберите контакт для начала общения</div>
                </div>
                
                <div class="message-input">
                    <textarea id="messageInput" placeholder="Напишите сообщение..." disabled rows="2"></textarea>
                    <button id="sendBtn" disabled>Отправить</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>© Личный Мессенджер</p>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <strong>Новое сообщение!</strong>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDTx2Y9ctiWp26YeMmAHAxDZd_gVI_ZMdw",
            authDomain: "kcalls.firebaseapp.com",
            databaseURL: "https://kcalls-default-rtdb.firebaseio.com",
            projectId: "kcalls",
            storageBucket: "kcalls.firebasestorage.app",
            messagingSenderId: "990117089104",
            appId: "1:990117089104:web:278a42c037e975ebb76655",
            measurementId: "G-TK6GVEX9G5"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Элементы DOM
        const loginPanel = document.getElementById('loginPanel');
        const userPanel = document.getElementById('userPanel');
        const usernameInput = document.getElementById('usernameInput');
        const loginBtn = document.getElementById('loginBtn');
        const deleteAccountBtn = document.getElementById('deleteAccountBtn');
        const currentUserName = document.getElementById('currentUserName');
        const currentUserId = document.getElementById('currentUserId');
        const copyIdBtn = document.getElementById('copyIdBtn');
        const friendIdInput = document.getElementById('friendIdInput');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const contactsList = document.getElementById('contactsList');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const notification = document.getElementById('notification');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        
        // Новые элементы для профиля
        const profileBtn = document.getElementById('profileBtn');
        const profileModal = document.getElementById('profileModal');
        const profileCloseBtn = document.getElementById('profileCloseBtn');
        const profileCancelBtn = document.getElementById('profileCancelBtn');
        const profileSaveBtn = document.getElementById('profileSaveBtn');
        const profileNameInput = document.getElementById('profileNameInput');
        const profileUserId = document.getElementById('profileUserId');
        const profileStatusText = document.getElementById('profileStatusText');
        const profileCreatedAt = document.getElementById('profileCreatedAt');
        const profileStatus = document.getElementById('profileStatus');
        const profileAvatarText = document.getElementById('profileAvatarText');
        const lastSeenBadge = document.getElementById('lastSeenBadge');
        
        let currentUser = null;
        let myUserId = null;
        let myUserData = null;
        let isSending = false;
        let currentChatWith = null;
        let lastLoadedMessageId = null;
        
        // Структуры для хранения данных
        let contacts = {};
        let users = {};
        let unreadMessages = {};
        let chatListeners = {};
        
        // Ключи для LocalStorage
        const STORAGE_KEYS = {
            USER_ID: 'messenger_user_id',
            USER_NAME: 'messenger_user_name',
            CONTACTS: 'messenger_contacts'
        };
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            showLoading();
            autoLogin();
        });
        
        // Показать загрузку
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }
        
        // Скрыть загрузку
        function hideLoading() {
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 500);
        }
        
        // Автоматический вход при загрузке
        function autoLogin() {
            const savedId = localStorage.getItem(STORAGE_KEYS.USER_ID);
            const savedName = localStorage.getItem(STORAGE_KEYS.USER_NAME);
            
            if (savedId && savedName) {
                // Есть сохраненный аккаунт - выполняем автоматический вход
                performAutoLogin(savedName, savedId);
            } else {
                // Нет сохраненного аккаунта - показываем форму входа
                hideLoading();
                showLoginForm();
            }
        }
        
        // Выполнить автоматический вход
        function performAutoLogin(username, userId) {
            currentUser = username;
            myUserId = userId;
            
            // Проверить существование пользователя в Firebase
            database.ref(`users/${myUserId}`).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Пользователь существует в Firebase
                    loginUserDirectly(username, userId);
                } else {
                    // Пользователя нет в Firebase, но есть в LocalStorage
                    // Создаем нового с тем же ID и именем
                    createNewUserWithExistingId(username, userId);
                }
            }).catch(error => {
                console.error('Ошибка проверки пользователя в Firebase:', error);
                // При ошибке все равно создаем пользователя
                createNewUserWithExistingId(username, userId);
            });
        }
        
        // Создать нового пользователя с существующим ID
        function createNewUserWithExistingId(username, userId) {
            currentUser = username;
            myUserId = userId;
            
            // Сохранить пользователя в Firebase
            saveUserToFirebase();
            
            // Показать интерфейс мессенджера
            showMessengerInterface();
            hideLoading();
            
            // Загрузить контакты
            loadContacts();
            
            showNotification(`Добро пожаловать обратно, ${username}!`);
        }
        
        // Прямой вход пользователя
        function loginUserDirectly(username, userId) {
            currentUser = username;
            myUserId = userId;
            
            myUserData = {
                username: currentUser,
                userId: myUserId,
                lastSeen: Date.now()
            };
            
            // Обновить время последней активности
            database.ref(`users/${myUserId}/lastSeen`).set(Date.now());
            
            // Показать интерфейс мессенджера
            showMessengerInterface();
            hideLoading();
            
            // Загрузить контакты
            loadContacts();
            
            showNotification(`Добро пожаловать обратно, ${username}!`);
            
            // Обновлять время последней активности каждую минуту
            setInterval(() => {
                if (myUserData) {
                    database.ref(`users/${myUserId}/lastSeen`).set(Date.now());
                }
            }, 60000);
        }
        
        // Показать форму входа
        function showLoginForm() {
            usernameInput.focus();
        }
        
        // Вход в систему
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (!username) {
                alert('Введите имя для входа в мессенджер!');
                return;
            }
            
            loginUser(username);
        });
        
        // Функция входа пользователя (новая регистрация)
        function loginUser(username) {
            showLoading();
            
            currentUser = username;
            myUserId = generateShortId();
            
            // Сохранить данные в LocalStorage
            saveUserToLocalStorage();
            
            // Сохранить пользователя в Firebase
            saveUserToFirebase();
            
            // Показать интерфейс мессенджера
            showMessengerInterface();
            hideLoading();
            
            // Загрузить контакты
            loadContacts();
            
            showNotification(`Добро пожаловать, ${username}!`);
        }
        
        // Показать интерфейс мессенджера
        function showMessengerInterface() {
            loginPanel.style.display = 'none';
            userPanel.style.display = 'flex';
            userPanel.style.flexDirection = 'column';
            profileBtn.style.display = 'flex';
            
            currentUserName.textContent = currentUser;
            currentUserId.textContent = myUserId;
            
            // Обновляем аватар
            updateProfileAvatar();
        }
        
        // Обновление аватара профиля
        function updateProfileAvatar() {
            if (currentUser && currentUser.length > 0) {
                profileAvatarText.textContent = currentUser.charAt(0).toUpperCase();
            }
        }
        
        // ОТКРЫТИЕ ПРОФИЛЯ
        profileBtn.addEventListener('click', openProfile);
        profileCloseBtn.addEventListener('click', closeProfile);
        profileCancelBtn.addEventListener('click', closeProfile);
        
        // Открыть профиль
        function openProfile() {
            // Заполняем данные профиля
            profileNameInput.value = currentUser;
            profileUserId.textContent = myUserId;
            
            // Обновляем статус онлайн/оффлайн
            updateOnlineStatus();
            
            // Обновляем дату создания аккаунта
            if (myUserData && myUserData.createdAt) {
                const createdDate = new Date(myUserData.createdAt);
                profileCreatedAt.textContent = createdDate.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else {
                profileCreatedAt.textContent = 'Неизвестно';
            }
            
            // Сбрасываем статус сообщений
            profileStatus.className = 'profile-status';
            profileStatus.style.display = 'none';
            
            // Показываем модальное окно
            profileModal.style.display = 'flex';
            profileNameInput.focus();
        }
        
        // Закрыть профиль
        function closeProfile() {
            profileModal.style.display = 'none';
        }
        
        // Обновление статуса онлайн
        function updateOnlineStatus() {
            if (myUserData && myUserData.lastSeen) {
                const lastSeenTime = myUserData.lastSeen;
                const currentTime = Date.now();
                const diffMinutes = Math.floor((currentTime - lastSeenTime) / 60000);
                
                if (diffMinutes < 3) {
                    // Онлайн (был в сети менее 3 минут назад)
                    profileStatusText.textContent = 'В сети';
                    lastSeenBadge.textContent = 'онлайн';
                    lastSeenBadge.className = 'last-seen-status last-seen-online';
                } else {
                    // Оффлайн
                    profileStatusText.textContent = 'Был в сети ' + getLastSeenText(lastSeenTime);
                    lastSeenBadge.textContent = 'оффлайн';
                    lastSeenBadge.className = 'last-seen-status last-seen-offline';
                }
            } else {
                profileStatusText.textContent = 'В сети';
                lastSeenBadge.textContent = 'онлайн';
                lastSeenBadge.className = 'last-seen-status last-seen-online';
            }
        }
        
        // СОХРАНЕНИЕ ПРОФИЛЯ
        profileSaveBtn.addEventListener('click', saveProfile);
        
        // Сохранение профиля
        function saveProfile() {
            const newUsername = profileNameInput.value.trim();
            
            if (!newUsername) {
                showProfileStatus('Введите имя пользователя', 'error');
                return;
            }
            
            if (newUsername.length > 20) {
                showProfileStatus('Имя не должно превышать 20 символов', 'error');
                return;
            }
            
            if (newUsername === currentUser) {
                showProfileStatus('Имя не изменилось', 'error');
                return;
            }
            
            // Сохраняем новое имя
            const oldUsername = currentUser;
            currentUser = newUsername;
            
            // Обновляем в интерфейсе
            currentUserName.textContent = newUsername;
            updateProfileAvatar();
            
            // Обновляем в LocalStorage
            localStorage.setItem(STORAGE_KEYS.USER_NAME, newUsername);
            
            // Обновляем в Firebase
            database.ref(`users/${myUserId}/username`).set(newUsername)
                .then(() => {
                    // Обновляем данные пользователя
                    myUserData.username = newUsername;
                    
                    // Показываем успешное сообщение
                    showProfileStatus('Имя успешно обновлено!', 'success');
                    
                    // Обновляем все сообщения с нашим старым именем
                    updateMessagesWithNewUsername(oldUsername, newUsername);
                    
                    // Уведомляем контактов об изменении имени
                    notifyContactsAboutNameChange(newUsername);
                    
                    // Закрываем профиль через 2 секунды
                    setTimeout(() => {
                        closeProfile();
                    }, 2000);
                })
                .catch(error => {
                    console.error('Ошибка обновления имени:', error);
                    showProfileStatus('Ошибка обновления имени', 'error');
                    // Возвращаем старое имя
                    currentUser = oldUsername;
                    currentUserName.textContent = oldUsername;
                    updateProfileAvatar();
                });
        }
        
        // Показать статус в профиле
        function showProfileStatus(message, type) {
            profileStatus.textContent = message;
            profileStatus.className = `profile-status ${type}`;
            profileStatus.style.display = 'block';
            
            // Автоматически скрываем через 5 секунд
            if (type === 'success') {
                setTimeout(() => {
                    profileStatus.style.display = 'none';
                }, 5000);
            }
        }
        
        // Обновить все сообщения с новым именем
        function updateMessagesWithNewUsername(oldUsername, newUsername) {
            // Для каждого контакта обновляем наши сообщения
            Object.keys(contacts).forEach(friendId => {
                const chatId = getChatId(friendId);
                
                // Находим и обновляем все наши сообщения в этом чате
                database.ref(`private_messages/${chatId}`).once('value').then(snapshot => {
                    const messages = snapshot.val();
                    if (!messages) return;
                    
                    Object.keys(messages).forEach(messageId => {
                        const message = messages[messageId];
                        if (message.senderId === myUserId && message.senderName === oldUsername) {
                            // Обновляем имя отправителя
                            database.ref(`private_messages/${chatId}/${messageId}/senderName`).set(newUsername);
                        }
                    });
                });
            });
        }
        
        // Уведомить контакты об изменении имени
        function notifyContactsAboutNameChange(newUsername) {
            Object.keys(contacts).forEach(friendId => {
                // Отправляем системное сообщение об изменении имени
                const messageData = {
                    senderId: 'system',
                    senderName: 'Система',
                    text: `Пользователь ${currentUser} изменил имя на ${newUsername}`,
                    timestamp: Date.now(),
                    chatId: getChatId(friendId),
                    type: 'system'
                };
                
                const chatId = getChatId(friendId);
                database.ref(`private_messages/${chatId}`).push(messageData);
            });
        }
        
        // Удаление аккаунта
        deleteAccountBtn.addEventListener('click', () => {
            confirmationModal.style.display = 'flex';
        });
        
        // Подтверждение удаления аккаунта
        confirmDeleteBtn.addEventListener('click', deleteAccount);
        
        // Отмена удаления аккаунта
        cancelDeleteBtn.addEventListener('click', () => {
            confirmationModal.style.display = 'none';
        });
        
        // Функция удаления аккаунта
        function deleteAccount() {
            showLoading();
            
            // 1. Удалить все чаты пользователя
            deleteAllUserChats();
            
            // 2. Удалить пользователя из контактов его друзей
            deleteUserFromFriendsContacts();
            
            // 3. Удалить контакты пользователя
            database.ref(`contacts/${myUserId}`).remove();
            
            // 4. Удалить пользователя
            database.ref(`users/${myUserId}`).remove()
                .then(() => {
                    // 5. Удалить данные из LocalStorage
                    clearLocalStorage();
                    
                    // 6. Сбросить состояние приложения
                    resetAppState();
                    
                    // 7. Скрыть окно подтверждения и загрузки
                    confirmationModal.style.display = 'none';
                    hideLoading();
                    
                    // 8. Показать форму входа
                    loginPanel.style.display = 'block';
                    userPanel.style.display = 'none';
                    profileBtn.style.display = 'none';
                    usernameInput.value = '';
                    
                    showNotification('Аккаунт успешно удален');
                })
                .catch(error => {
                    console.error('Ошибка при удалении аккаунта:', error);
                    hideLoading();
                    confirmationModal.style.display = 'none';
                    alert('Произошла ошибка при удалении аккаунта');
                });
        }
        
        // Удалить все чаты пользователя
        function deleteAllUserChats() {
            // Получить все ID чатов, в которых участвует пользователь
            Object.keys(contacts).forEach(friendId => {
                const chatId = getChatId(friendId);
                database.ref(`private_messages/${chatId}`).remove();
            });
        }
        
        // Удалить пользователя из контактов его друзей
        function deleteUserFromFriendsContacts() {
            Object.keys(contacts).forEach(friendId => {
                database.ref(`contacts/${friendId}/${myUserId}`).remove();
            });
        }
        
        // Очистить LocalStorage
        function clearLocalStorage() {
            localStorage.removeItem(STORAGE_KEYS.USER_ID);
            localStorage.removeItem(STORAGE_KEYS.USER_NAME);
            localStorage.removeItem(STORAGE_KEYS.CONTACTS);
        }
        
        // Сбросить состояние приложения
        function resetAppState() {
            // Отключить все слушатели
            Object.keys(chatListeners).forEach(chatId => {
                database.ref(`private_messages/${chatId}`).off('child_added', chatListeners[chatId]);
            });
            
            // Отписаться от всех контактов
            Object.keys(contacts).forEach(userId => {
                database.ref(`users/${userId}`).off();
            });
            
            // Отписаться от списка контактов
            database.ref(`contacts/${myUserId}`).off();
            
            // Сбросить состояние
            currentUser = null;
            myUserId = null;
            myUserData = null;
            currentChatWith = null;
            lastLoadedMessageId = null;
            contacts = {};
            users = {};
            unreadMessages = {};
            chatListeners = {};
            
            // Деактивировать поле ввода сообщений
            messageInput.disabled = true;
            sendBtn.disabled = true;
            
            // Очистить списки
            contactsList.innerHTML = '<div class="empty-chat">Добавьте друга по ID</div>';
            chatMessages.innerHTML = '<div class="empty-chat">Выберите контакт для начала общения</div>';
        }
        
        // Копировать ID
        copyIdBtn.addEventListener('click', () => {
            const textToCopy = myUserId;
            
            // Создаем временный textarea элемент
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            
            textarea.focus();
            textarea.select();
            
            try {
                // Пробуем использовать современный API
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('ID скопирован в буфер обмена!');
                } else {
                    // Если не сработало, используем старый метод
                    copyUsingOldMethod(textToCopy);
                }
            } catch (err) {
                // Если execCommand не поддерживается
                copyUsingOldMethod(textToCopy);
            }
            
            // Удаляем временный элемент
            document.body.removeChild(textarea);
        });
        
        // Старый метод копирования
        function copyUsingOldMethod(text) {
            try {
                // Пробуем использовать современный Clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => {
                        showNotification('ID скопирован! Поделитесь им с друзьями');
                    }).catch(err => {
                        fallbackCopy(text);
                    });
                } else {
                    fallbackCopy(text);
                }
            } catch (err) {
                fallbackCopy(text);
            }
        }
        
        // Фолбэк копирование
        function fallbackCopy(text) {
            // Создаем временный элемент input
            const input = document.createElement('input');
            input.style.position = 'fixed';
            input.style.opacity = 0;
            input.value = text;
            document.body.appendChild(input);
            
            input.select();
            input.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showNotification('ID скопирован!');
            } catch (err) {
                alert('Не удалось скопировать ID. Скопируйте вручную: ' + text);
            }
            
            document.body.removeChild(input);
        }
        
        // Добавить друга
        addFriendBtn.addEventListener('click', addFriend);
        friendIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addFriend();
            }
        });
        
        // Отправка сообщения
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Генерация короткого ID (до 8 символов)
        function generateShortId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Сохранение пользователя в LocalStorage
        function saveUserToLocalStorage() {
            localStorage.setItem(STORAGE_KEYS.USER_ID, myUserId);
            localStorage.setItem(STORAGE_KEYS.USER_NAME, currentUser);
        }
        
        // Сохранение контактов в LocalStorage
        function saveContactsToLocalStorage() {
            localStorage.setItem(STORAGE_KEYS.CONTACTS, JSON.stringify(contacts));
        }
        
        // Загрузка контактов из LocalStorage
        function loadContactsFromLocalStorage() {
            const savedContacts = localStorage.getItem(STORAGE_KEYS.CONTACTS);
            if (savedContacts) {
                try {
                    return JSON.parse(savedContacts);
                } catch (e) {
                    console.error('Ошибка загрузки контактов из LocalStorage:', e);
                }
            }
            return {};
        }
        
        // Сохранение пользователя в Firebase
        function saveUserToFirebase() {
            myUserData = {
                username: currentUser,
                userId: myUserId,
                createdAt: Date.now(),
                lastSeen: Date.now()
            };
            
            database.ref(`users/${myUserId}`).set(myUserData);
            
            // Обновлять время последней активности каждую минуту
            setInterval(() => {
                if (myUserData) {
                    database.ref(`users/${myUserId}/lastSeen`).set(Date.now());
                }
            }, 60000);
        }
        
        // Загрузка контактов
        function loadContacts() {
            // Сначала загружаем из LocalStorage
            contacts = loadContactsFromLocalStorage();
            
            // Затем подписываемся на обновления из Firebase
            database.ref(`contacts/${myUserId}`).on('value', (snapshot) => {
                const firebaseContacts = snapshot.val() || {};
                
                // Объединяем контакты из LocalStorage и Firebase
                // Предпочтение отдается Firebase, так как там актуальные данные
                contacts = { ...contacts, ...firebaseContacts };
                
                // Сохраняем объединенные контакты обратно в LocalStorage
                saveContactsToLocalStorage();
                
                // Загрузить информацию о пользователях-контактах
                loadContactUsers();
                
                // Обновить список контактов
                updateContactsList();
                
                // Подписаться на чаты с контактами
                subscribeToContactChats();
            });
        }
        
        // Загрузка информации о пользователях-контактах
        function loadContactUsers() {
            Object.keys(contacts).forEach(userId => {
                database.ref(`users/${userId}`).on('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        users[userId] = userData;
                        updateContactsList();
                    }
                });
            });
        }
        
        // Обновление списка контактов
        function updateContactsList() {
            contactsList.innerHTML = '';
            
            if (Object.keys(contacts).length === 0) {
                contactsList.innerHTML = '<div class="empty-chat">Добавьте друга по ID</div>';
                return;
            }
            
            Object.keys(contacts).forEach(userId => {
                const user = users[userId];
                const contactItem = document.createElement('div');
                contactItem.className = `contact-item ${currentChatWith === userId ? 'active' : ''}`;
                contactItem.dataset.userId = userId;
                
                const displayName = user ? user.username : 'Неизвестный пользователь';
                const lastSeen = user ? getLastSeenText(user.lastSeen) : '';
                const unreadCount = unreadMessages[userId] || 0;
                
                contactItem.innerHTML = `
                    <div style="flex: 1;">
                        <div class="contact-name">${escapeHtml(displayName)}</div>
                        <div class="contact-id">ID: ${userId}</div>
                        ${lastSeen ? `<div style="font-size: 9px; color: #888;">${lastSeen}</div>` : ''}
                    </div>
                    ${unreadCount > 0 ? `<div class="new-message-indicator">${unreadCount}</div>` : ''}
                `;
                
                contactItem.addEventListener('click', () => {
                    openChat(userId);
                });
                
                contactsList.appendChild(contactItem);
            });
        }
        
        // Подписаться на чаты с контактами
        function subscribeToContactChats() {
            Object.keys(contacts).forEach(userId => {
                subscribeToChat(userId);
            });
        }
        
        // Подписаться на чат с пользователем
        function subscribeToChat(otherUserId) {
            const chatId = getChatId(otherUserId);
            
            // Если уже есть слушатель для этого чата, не создаем новый
            if (chatListeners[chatId]) {
                return;
            }
            
            const listener = database.ref(`private_messages/${chatId}`).on('child_added', (snapshot) => {
                const message = snapshot.val();
                const messageId = snapshot.key;
                
                // Пропускаем если это наше сообщение
                if (message.senderId === myUserId) {
                    return;
                }
                
                // Если чат открыт - отображаем сообщение
                if (currentChatWith === otherUserId) {
                    // Проверяем, не отображали ли уже это сообщение
                    if (messageId === lastLoadedMessageId) {
                        return;
                    }
                    
                    displayMessage(message);
                    lastLoadedMessageId = messageId;
                    
                    // Прокручиваем вниз
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 50);
                } else {
                    // Если чат не открыт - увеличиваем счетчик непрочитанных
                    unreadMessages[otherUserId] = (unreadMessages[otherUserId] || 0) + 1;
                    updateContactsList();
                    
                    // Показать уведомление
                    showNotification(`Новое сообщение от ${users[otherUserId]?.username || 'пользователя'}`);
                }
            });
            
            chatListeners[chatId] = listener;
        }
        
        // Добавление друга
        function addFriend() {
            const friendId = friendIdInput.value.trim();
            if (!friendId) {
                alert('Введите ID друга');
                return;
            }
            
            // Проверка длины ID
            if (friendId.length > 8) {
                alert('ID должен быть не более 8 символов');
                return;
            }
            
            if (friendId === myUserId) {
                alert('Нельзя добавить самого себя!');
                friendIdInput.value = '';
                return;
            }
            
            if (contacts[friendId]) {
                alert('Этот пользователь уже в вашем списке контактов');
                friendIdInput.value = '';
                return;
            }
            
            // Проверить существование пользователя
            database.ref(`users/${friendId}`).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Добавить в контакты
                    contacts[friendId] = {
                        addedAt: Date.now()
                    };
                    
                    // Сохранить в LocalStorage
                    saveContactsToLocalStorage();
                    
                    // Сохранить в Firebase
                    database.ref(`contacts/${myUserId}/${friendId}`).set({
                        addedAt: Date.now()
                    });
                    
                    // Также добавить себя в контакты друга
                    database.ref(`contacts/${friendId}/${myUserId}`).set({
                        addedAt: Date.now()
                    });
                    
                    friendIdInput.value = '';
                    showNotification('Друг добавлен!');
                    
                    // Подписаться на чат с новым другом
                    subscribeToChat(friendId);
                    
                    // Открыть чат с новым другом
                    openChat(friendId);
                } else {
                    alert('Пользователь с таким ID не найден');
                    friendIdInput.value = '';
                }
            }).catch(error => {
                console.error('Ошибка при добавлении друга:', error);
                alert('Ошибка при добавлении друга');
            });
        }
        
        // Открыть чат с пользователем
        function openChat(userId) {
            if (currentChatWith === userId) return;
            
            currentChatWith = userId;
            lastLoadedMessageId = null;
            
            // Сбросить счетчик непрочитанных для этого чата
            unreadMessages[userId] = 0;
            updateContactsList();
            
            // Обновить активный контакт
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.userId === userId) {
                    item.classList.add('active');
                }
            });
            
            // Активировать поле ввода
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
            
            // Загрузить историю сообщений
            loadChatHistory(userId);
        }
        
        // Получить ID чата (уникальный для пары пользователей)
        function getChatId(otherUserId) {
            if (!otherUserId) return null;
            const ids = [myUserId, otherUserId].sort();
            return ids.join('_');
        }
        
        // Загрузить историю сообщений
        function loadChatHistory(otherUserId) {
            const chatId = getChatId(otherUserId);
            
            database.ref(`private_messages/${chatId}`).limitToLast(50).once('value').then((snapshot) => {
                const messages = snapshot.val();
                chatMessages.innerHTML = '';
                
                if (!messages) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-chat';
                    emptyDiv.textContent = `Начните общение с ${users[otherUserId]?.username || 'пользователем'}`;
                    chatMessages.appendChild(emptyDiv);
                    return;
                }
                
                // Получаем ключи сообщений
                const messageIds = Object.keys(messages);
                
                // Преобразуем объект в массив и сортируем по времени
                const messagesArray = Object.values(messages);
                messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                // Отображаем историю сообщений
                messagesArray.forEach((message, index) => {
                    displayMessage(message);
                    
                    // Запоминаем ID последнего сообщения
                    if (index === messagesArray.length - 1) {
                        lastLoadedMessageId = messageIds[index];
                    }
                });
                
                // Прокручиваем вниз
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }).catch(error => {
                console.error('Ошибка загрузки истории сообщений:', error);
                chatMessages.innerHTML = '<div class="empty-chat">Ошибка загрузки истории</div>';
            });
        }
        
        // Отправка сообщения
        function sendMessage() {
            if (isSending || !currentChatWith || !messageInput.value.trim()) return;
            
            const messageText = messageInput.value.trim();
            if (messageText.length > 1000) {
                alert('Сообщение слишком длинное (максимум 1000 символов)');
                return;
            }
            
            isSending = true;
            
            const messageData = {
                senderId: myUserId,
                senderName: currentUser,
                text: messageText,
                timestamp: Date.now(),
                chatId: getChatId(currentChatWith)
            };
            
            const chatId = getChatId(currentChatWith);
            
            // Добавить сообщение локально сразу
            displayMessage({
                senderId: myUserId,
                senderName: currentUser,
                text: messageText,
                timestamp: messageData.timestamp
            });
            
            // Добавить сообщение в Firebase
            database.ref(`private_messages/${chatId}`).push(messageData)
                .then(() => {
                    // Успешно отправлено
                    messageInput.value = '';
                    messageInput.focus();
                    
                    // Прокручиваем вниз
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 50);
                })
                .catch((error) => {
                    console.error('Ошибка отправки сообщения:', error);
                    alert('Ошибка отправки сообщения');
                })
                .finally(() => {
                    setTimeout(() => {
                        isSending = false;
                    }, 500);
                });
        }
        
        // Отображение сообщения
        function displayMessage(message) {
            // Убираем сообщение "Начните общение"
            if (chatMessages.querySelector('.empty-chat')) {
                chatMessages.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            const isMyMessage = message.senderId === myUserId;
            
            // Форматируем время
            const date = new Date(message.timestamp);
            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.className = `message ${isMyMessage ? 'message-sent' : 'message-received'}`;
            messageDiv.innerHTML = `
                <div class="message-sender">${isMyMessage ? 'Вы' : escapeHtml(message.senderName)}</div>
                <div class="message-text">${escapeHtml(message.text)}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
        }
        
        // Получить текст "был в сети"
        function getLastSeenText(lastSeen) {
            if (!lastSeen) return '';
            
            const diff = Date.now() - lastSeen;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'только что';
            if (minutes < 60) return `${minutes} мин назад`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} ч назад`;
            
            const days = Math.floor(hours / 24);
            return `${days} дн назад`;
        }
        
        // Экранирование HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Показать уведомление
        function showNotification(text) {
            notification.innerHTML = `<strong>${escapeHtml(text)}</strong>`;
            notification.style.display = 'block';
            notification.classList.add('blink');
            
            // Воспроизвести звук уведомления
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log("Аудио не поддерживается");
            }
            
            // Скрыть уведомление через 5 секунд
            setTimeout(() => {
                notification.style.display = 'none';
                notification.classList.remove('blink');
            }, 5000);
        }
        
        // Обработка видимости страницы для уведомлений
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                notification.style.display = 'none';
                notification.classList.remove('blink');
                // Обновляем статус при возвращении на вкладку
                if (myUserData) {
                    updateOnlineStatus();
                }
            }
        });
        
        // Обновление статуса онлайн каждые 30 секунд
        setInterval(() => {
            if (myUserData) {
                updateOnlineStatus();
            }
        }, 30000);
    </script>
</body>
</html>